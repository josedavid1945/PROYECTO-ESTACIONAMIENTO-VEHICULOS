# =====================================================
# DOCKER COMPOSE - CON SUPABASE (DB REMOTA)
# =====================================================
# Usa este archivo cuando tu base de datos est√° en Supabase
# No incluye contenedor PostgreSQL local
# =====================================================
# Uso: docker-compose -f docker-compose-supabase.yml up -d
# =====================================================

services:
  # ==================== BACKEND REST API ====================
  backend-rest:
    build:
      context: ./backend-rest/API - copia/alquiler-rest
      dockerfile: Dockerfile
    container_name: parking-backend-rest
    restart: unless-stopped
    environment:
      NODE_ENV: production
      PORT: 3000
      DB_HOST: ${DB_HOST}
      DB_PORT: ${DB_PORT:-5432}
      DB_USERNAME: ${DB_USERNAME}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_DATABASE: ${DB_DATABASE}
      DB_SSL: ${DB_SSL:-true}
    ports:
      - "3000:3000"
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000/dashboard/health"]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 45s
    networks:
      - parking-network

  # ==================== AUTH SERVICE ====================
  auth-service:
    build:
      context: ./auth-service
      dockerfile: Dockerfile
    container_name: parking-auth
    restart: unless-stopped
    environment:
      NODE_ENV: production
      PORT: 3003
      JWT_ACCESS_SECRET: ${JWT_SECRET:-super_secret_access_jwt_key_change_in_production}
      JWT_REFRESH_SECRET: ${JWT_SECRET:-super_secret_refresh_jwt_key_change_in_production}
      JWT_EXPIRES_IN: ${JWT_ACCESS_EXPIRATION:-24h}
      DB_HOST: ${DB_HOST}
      DB_PORT: ${DB_PORT:-5432}
      DB_USERNAME: ${DB_USERNAME}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_DATABASE: ${DB_DATABASE}
      DB_SSL: ${DB_SSL:-true}
    ports:
      - "3003:3003"
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3003/auth/health"]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 45s
    networks:
      - parking-network

  # ==================== GRAPHQL SERVICE ====================
  graphql-service:
    build:
      context: ./graphql-service
      dockerfile: Dockerfile
    container_name: parking-graphql
    restart: unless-stopped
    environment:
      HOST: 0.0.0.0
      PORT: 8000
      DEBUG: "false"
      DATABASE_URL: ${DATABASE_URL}
      CORS_ORIGINS: ${CORS_ORIGINS:-http://localhost:4200,http://localhost}
    ports:
      - "8000:8000"
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/')"]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 45s
    networks:
      - parking-network

  # ==================== WEBSOCKET SERVER ====================
  websocket-server:
    build:
      context: ./websocket-server
      dockerfile: Dockerfile
    container_name: parking-websocket
    restart: unless-stopped
    environment:
      PORT: 8080
      MODE: rest
      REST_API_URL: http://backend-rest:3000
      ALLOWED_ORIGINS: http://localhost,http://localhost:80,http://localhost:4200,http://127.0.0.1
      DATABASE_URL: ${DATABASE_URL}
    ports:
      - "8080:8080"
    depends_on:
      backend-rest:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8080/health"]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 30s
    networks:
      - parking-network

  # ==================== B2B WEBHOOKS SYSTEM ====================
  b2b-webhooks:
    build:
      context: ./b2b-webhooks-system
      dockerfile: Dockerfile
    container_name: parking-b2b
    restart: unless-stopped
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      PORT: 3001
      DATABASE_URL: ${DATABASE_URL}
      DB_SSL: ${DB_SSL:-true}
      GEMINI_API_KEY: ${GEMINI_API_KEY:-}
      GEMINI_API_KEY_BACKUP: ${GEMINI_API_KEY_BACKUP:-}
      PARKING_API_URL: http://parking-backend-rest:3000
    ports:
      - "3001:3001"
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3001/health"]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 45s
    networks:
      - parking-network

  # ==================== FRONTEND ====================
  frontend:
    build:
      context: ./frontend/Frontend
      dockerfile: Dockerfile
    container_name: parking-frontend
    restart: unless-stopped
    ports:
      - "80:80"
    depends_on:
      - backend-rest
      - graphql-service
      - websocket-server
      - auth-service
    networks:
      - parking-network

  # ==================== N8N - EVENT BUS (PARTNER HANDLER) ====================
  n8n:
    image: n8nio/n8n:latest
    container_name: parking-n8n
    restart: unless-stopped
    environment:
      - N8N_BASIC_AUTH_ACTIVE=true
      - N8N_BASIC_AUTH_USER=admin
      - N8N_BASIC_AUTH_PASSWORD=${N8N_PASSWORD:-parking2026}
      - N8N_HOST=localhost
      - N8N_PORT=5678
      - N8N_PROTOCOL=http
      - WEBHOOK_URL=http://n8n:5678/
      - GENERIC_TIMEZONE=America/La_Paz
      # Variables para conectar con el sistema
      - B2B_API_URL=http://b2b-webhooks:3002
      - BACKEND_API_URL=http://backend-rest:3000
    ports:
      - "5678:5678"
    volumes:
      - ./n8n-data:/home/node/.n8n
    networks:
      - parking-network

networks:
  parking-network:
    driver: bridge
