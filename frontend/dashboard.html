<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Sistema de Estacionamiento</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            margin-bottom: 10px;
        }

        .connection-status {
            display: inline-block;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
            margin-top: 10px;
        }

        .status-connected {
            background: #4caf50;
            color: white;
        }

        .status-disconnected {
            background: #f44336;
            color: white;
        }

        .status-connecting {
            background: #ff9800;
            color: white;
        }

        /* Tarjetas de estadÃ­sticas */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 12px rgba(0,0,0,0.15);
        }

        .stat-card h3 {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-card .value {
            font-size: 3em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-card .label {
            font-size: 12px;
            color: #999;
        }

        .stat-card.disponibles .value { color: #4caf50; }
        .stat-card.ocupados .value { color: #f44336; }
        .stat-card.total .value { color: #2196f3; }
        .stat-card.dinero .value { color: #ff9800; }
        .stat-card.vehiculos .value { color: #9c27b0; }

        /* Secciones */
        .section {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .section h2 {
            font-size: 1.5em;
            margin-bottom: 20px;
            color: #667eea;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        /* Tabla de espacios por secciÃ³n */
        .secciones-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .seccion-card {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .seccion-card h3 {
            font-size: 1.2em;
            margin-bottom: 10px;
            color: #667eea;
        }

        .seccion-stats {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 14px;
        }

        .seccion-stats span {
            padding: 5px 10px;
            border-radius: 5px;
            background: white;
        }

        .seccion-stats .disponibles {
            color: #4caf50;
            font-weight: bold;
        }

        .seccion-stats .ocupados {
            color: #f44336;
            font-weight: bold;
        }

        /* Tabla de tickets activos */
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        table thead {
            background: #667eea;
            color: white;
        }

        table th, table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        table tbody tr:hover {
            background: #f5f5f5;
        }

        table tbody tr:nth-child(even) {
            background: #fafafa;
        }

        /* Indicador de actualizaciÃ³n */
        .update-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            font-size: 14px;
        }

        .update-indicator.updating {
            background: #4caf50;
            color: white;
        }

        /* Loading spinner */
        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #999;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ðŸš— Dashboard de Estacionamiento</h1>
            <div id="connectionStatus" class="connection-status status-disconnected">
                Desconectado
            </div>
        </header>

        <!-- EstadÃ­sticas principales -->
        <div class="stats-grid">
            <div class="stat-card disponibles">
                <h3>Espacios Disponibles</h3>
                <div class="value" id="espaciosDisponibles">-</div>
                <div class="label">Listos para usar</div>
            </div>
            
            <div class="stat-card ocupados">
                <h3>Espacios Ocupados</h3>
                <div class="value" id="espaciosOcupados">-</div>
                <div class="label">En uso actualmente</div>
            </div>
            
            <div class="stat-card total">
                <h3>Total de Espacios</h3>
                <div class="value" id="totalEspacios">-</div>
                <div class="label">Capacidad total</div>
            </div>
            
            <div class="stat-card dinero">
                <h3>Recaudado Hoy</h3>
                <div class="value" id="dineroHoy">$0</div>
                <div class="label">Ingresos del dÃ­a</div>
            </div>
            
            <div class="stat-card dinero">
                <h3>Recaudado Este Mes</h3>
                <div class="value" id="dineroMes">$0</div>
                <div class="label">Ingresos mensuales</div>
            </div>
            
            <div class="stat-card vehiculos">
                <h3>VehÃ­culos Activos</h3>
                <div class="value" id="vehiculosActivos">-</div>
                <div class="label">Estacionados ahora</div>
            </div>
        </div>

        <!-- Espacios por secciÃ³n -->
        <div class="section">
            <h2>ðŸ“Š Espacios por SecciÃ³n</h2>
            <div id="seccionesContainer" class="secciones-grid">
                <div class="no-data">Cargando datos...</div>
            </div>
        </div>

        <!-- Tickets activos -->
        <div class="section">
            <h2>ðŸŽ« Tickets Activos</h2>
            <div id="ticketsContainer">
                <div class="no-data">Cargando datos...</div>
            </div>
        </div>

        <!-- Indicador de actualizaciÃ³n -->
        <div id="updateIndicator" class="update-indicator">
            <span>Ãšltima actualizaciÃ³n: <span id="lastUpdate">-</span></span>
        </div>
    </div>

    <script>
        // ConfiguraciÃ³n segÃºn entorno
        const isProduction = window.location.protocol === 'https:';
        const CONFIG = {
            WS_URL: isProduction 
                ? 'wss://tu-websocket-server.render.com/ws'
                : 'ws://localhost:8081/ws',
            REST_URL: isProduction
                ? 'https://tu-rest-api.vercel.app'
                : 'http://localhost:3000'
        };

        console.log('ðŸ”§ ConfiguraciÃ³n:', CONFIG);
        console.log('ðŸŒ Entorno:', isProduction ? 'ProducciÃ³n' : 'Desarrollo');

        let ws = null;
        let reconnectTimeout = null;
        let reconnectAttempts = 0;
        const MAX_RECONNECT_ATTEMPTS = 5;

        // Elementos del DOM
        const elements = {
            connectionStatus: document.getElementById('connectionStatus'),
            espaciosDisponibles: document.getElementById('espaciosDisponibles'),
            espaciosOcupados: document.getElementById('espaciosOcupados'),
            totalEspacios: document.getElementById('totalEspacios'),
            dineroHoy: document.getElementById('dineroHoy'),
            dineroMes: document.getElementById('dineroMes'),
            vehiculosActivos: document.getElementById('vehiculosActivos'),
            seccionesContainer: document.getElementById('seccionesContainer'),
            ticketsContainer: document.getElementById('ticketsContainer'),
            updateIndicator: document.getElementById('updateIndicator'),
            lastUpdate: document.getElementById('lastUpdate')
        };

        // Conectar al WebSocket
        function connectWebSocket() {
            console.log('ðŸ”Œ Conectando a WebSocket:', CONFIG.WS_URL);
            
            updateConnectionStatus('connecting', 'Conectando...');
            
            ws = new WebSocket(CONFIG.WS_URL);

            ws.onopen = () => {
                console.log('âœ… WebSocket conectado');
                updateConnectionStatus('connected', 'ðŸŸ¢ Conectado');
                reconnectAttempts = 0;
                
                // Solicitar datos iniciales
                requestDashboardData();
            };

            ws.onmessage = (event) => {
                try {
                    const message = JSON.parse(event.data);
                    console.log('ðŸ“¨ Mensaje recibido:', message);
                    
                    // El WebSocket envÃ­a: { type: "dashboard_update", data: {...} }
                    if (message.type === 'dashboard_update' || message.type === 'dashboard_data' || message.type === 'dashboard') {
                        // Parsear el campo data si es string
                        let data = message.data;
                        if (typeof data === 'string') {
                            data = JSON.parse(data);
                        }
                        
                        console.log('ðŸ“Š Datos del dashboard:', data);
                        updateDashboard(data);
                    }
                    
                    updateLastUpdateTime();
                } catch (error) {
                    console.error('âŒ Error procesando mensaje:', error, event.data);
                }
            };

            ws.onerror = (error) => {
                console.error('âŒ Error de WebSocket:', error);
                updateConnectionStatus('disconnected', 'ðŸ”´ Error de conexiÃ³n');
            };

            ws.onclose = () => {
                console.log('ðŸ”Œ WebSocket desconectado');
                updateConnectionStatus('disconnected', 'ðŸ”´ Desconectado');
                
                // Intentar reconectar
                if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
                    reconnectAttempts++;
                    const delay = Math.min(1000 * Math.pow(2, reconnectAttempts), 30000);
                    console.log(`ðŸ”„ Reintentando conexiÃ³n en ${delay/1000}s... (Intento ${reconnectAttempts}/${MAX_RECONNECT_ATTEMPTS})`);
                    
                    reconnectTimeout = setTimeout(connectWebSocket, delay);
                } else {
                    console.error('âŒ MÃ¡ximo de intentos de reconexiÃ³n alcanzado');
                    updateConnectionStatus('disconnected', 'ðŸ”´ Sin conexiÃ³n');
                }
            };
        }

        // Actualizar estado de conexiÃ³n
        function updateConnectionStatus(status, text) {
            elements.connectionStatus.className = `connection-status status-${status}`;
            elements.connectionStatus.textContent = text;
        }

        // Solicitar datos del dashboard
        function requestDashboardData() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ 
                    action: 'get_dashboard',
                    type: 'request_dashboard'
                }));
                console.log('ðŸ“¤ Solicitando datos del dashboard');
            }
        }

        // Actualizar dashboard con los datos recibidos
        function updateDashboard(data) {
            console.log('ðŸ”„ Actualizando dashboard con datos:', data);
            
            // Los campos vienen del Go en diferentes formatos, manejar ambos
            elements.espaciosDisponibles.textContent = data.espacios_disponibles ?? data.EspaciosDisponibles ?? '-';
            elements.espaciosOcupados.textContent = data.espacios_ocupados ?? data.EspaciosOcupados ?? '-';
            elements.totalEspacios.textContent = data.total_espacios ?? data.TotalEspacios ?? '-';
            elements.dineroHoy.textContent = formatMoney(data.dinero_recaudado_hoy ?? data.DineroRecaudadoHoy ?? 0);
            elements.dineroMes.textContent = formatMoney(data.dinero_recaudado_mes ?? data.DineroRecaudadoMes ?? 0);
            elements.vehiculosActivos.textContent = data.vehiculos_activos ?? data.VehiculosActivos ?? '-';
            
            console.log('âœ… Dashboard actualizado:', {
                disponibles: elements.espaciosDisponibles.textContent,
                ocupados: elements.espaciosOcupados.textContent,
                total: elements.totalEspacios.textContent,
                dineroHoy: elements.dineroHoy.textContent,
                dineroMes: elements.dineroMes.textContent,
                vehiculos: elements.vehiculosActivos.textContent
            });
            
            // Si hay datos de secciones, actualizarlas
            if (data.secciones) {
                updateSecciones(data.secciones);
            }
            
            // Si hay tickets activos, actualizarlos
            if (data.tickets_activos) {
                updateTickets(data.tickets_activos);
            }
            
            elements.updateIndicator.classList.add('updating');
            setTimeout(() => {
                elements.updateIndicator.classList.remove('updating');
            }, 500);
        }

        // Actualizar secciones
        function updateSecciones(secciones) {
            if (!secciones || secciones.length === 0) {
                elements.seccionesContainer.innerHTML = '<div class="no-data">No hay datos de secciones</div>';
                return;
            }
            
            elements.seccionesContainer.innerHTML = secciones.map(seccion => `
                <div class="seccion-card">
                    <h3>SecciÃ³n ${seccion.seccion_letra}</h3>
                    <div class="seccion-stats">
                        <span class="disponibles">âœ“ ${seccion.espacios_disponibles} disponibles</span>
                        <span class="ocupados">âœ— ${seccion.espacios_ocupados} ocupados</span>
                    </div>
                    <div style="margin-top: 10px; font-size: 12px; color: #666;">
                        Total: ${seccion.total_espacios} espacios
                    </div>
                </div>
            `).join('');
        }

        // Actualizar tickets activos
        function updateTickets(tickets) {
            if (!tickets || tickets.length === 0) {
                elements.ticketsContainer.innerHTML = '<div class="no-data">No hay tickets activos</div>';
                return;
            }
            
            elements.ticketsContainer.innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Placa</th>
                            <th>Espacio</th>
                            <th>Hora Ingreso</th>
                            <th>Tiempo Estacionado</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${tickets.map(ticket => `
                            <tr>
                                <td><strong>${ticket.vehiculo_placa || 'N/A'}</strong></td>
                                <td>${ticket.espacio_numero || 'N/A'}</td>
                                <td>${formatDateTime(ticket.fecha_ingreso)}</td>
                                <td>${calculateDuration(ticket.fecha_ingreso)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // Formatear dinero
        function formatMoney(amount) {
            return new Intl.NumberFormat('es-MX', {
                style: 'currency',
                currency: 'MXN'
            }).format(amount);
        }

        // Formatear fecha y hora
        function formatDateTime(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleString('es-MX', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Calcular duraciÃ³n
        function calculateDuration(startDate) {
            if (!startDate) return 'N/A';
            const start = new Date(startDate);
            const now = new Date();
            const diff = now - start;
            
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            
            return `${hours}h ${minutes}m`;
        }

        // Actualizar hora de Ãºltima actualizaciÃ³n
        function updateLastUpdateTime() {
            const now = new Date();
            elements.lastUpdate.textContent = now.toLocaleTimeString('es-MX');
        }

        // Iniciar conexiÃ³n al cargar la pÃ¡gina
        window.addEventListener('load', () => {
            console.log('ðŸš€ Iniciando aplicaciÃ³n...');
            connectWebSocket();
        });

        // Limpiar al cerrar la pÃ¡gina
        window.addEventListener('beforeunload', () => {
            if (ws) {
                ws.close();
            }
            if (reconnectTimeout) {
                clearTimeout(reconnectTimeout);
            }
        });
    </script>
</body>
</html>
