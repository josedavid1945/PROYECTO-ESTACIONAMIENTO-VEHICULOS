<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Autom√°tico - WebSocket + REST API</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
        }

        h1 {
            color: white;
            font-size: 2em;
            margin-bottom: 10px;
        }

        .status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
        }

        .status.success { background: #4caf50; color: white; }
        .status.error { background: #f44336; color: white; }
        .status.warning { background: #ff9800; color: white; }
        .status.info { background: #2196f3; color: white; }

        .grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 968px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }

        .panel {
            background: #252526;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #3e3e42;
        }

        .panel h2 {
            color: #4ec9b0;
            margin-bottom: 15px;
            font-size: 1.3em;
            border-bottom: 2px solid #4ec9b0;
            padding-bottom: 10px;
        }

        .console {
            background: #1e1e1e;
            border: 1px solid #3e3e42;
            border-radius: 4px;
            padding: 15px;
            height: 500px;
            overflow-y: auto;
            font-size: 13px;
            line-height: 1.6;
        }

        .log-entry {
            margin-bottom: 8px;
            padding: 5px;
            border-left: 3px solid transparent;
        }

        .log-entry.success { border-left-color: #4caf50; color: #4caf50; }
        .log-entry.error { border-left-color: #f44336; color: #f44336; }
        .log-entry.warning { border-left-color: #ff9800; color: #ff9800; }
        .log-entry.info { border-left-color: #2196f3; color: #2196f3; }
        .log-entry.ws { border-left-color: #ce9178; color: #ce9178; }

        .timestamp {
            color: #858585;
            font-size: 11px;
            margin-right: 10px;
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        button {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .btn-primary { background: #007acc; color: white; }
        .btn-success { background: #4caf50; color: white; }
        .btn-danger { background: #f44336; color: white; }
        .btn-warning { background: #ff9800; color: white; }
        .btn-info { background: #2196f3; color: white; }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .stat-box {
            background: #1e1e1e;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
            border: 1px solid #3e3e42;
        }

        .stat-box .value {
            font-size: 2em;
            font-weight: bold;
            color: #4ec9b0;
            margin-bottom: 5px;
        }

        .stat-box .label {
            font-size: 12px;
            color: #858585;
            text-transform: uppercase;
        }

        .ws-message {
            background: #2d2d30;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
            border-left: 3px solid #ce9178;
        }

        .ws-message pre {
            margin: 0;
            color: #d4d4d4;
            font-size: 12px;
            overflow-x: auto;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #3e3e42;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
        }

        .test-info {
            background: #2d2d30;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            border-left: 4px solid #2196f3;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üß™ Test Autom√°tico del Sistema</h1>
            <p style="color: #fff; opacity: 0.9; margin-top: 10px;">
                WebSocket ‚Üí REST API ‚Üí Database
            </p>
            <div style="margin-top: 15px;">
                <span class="status info" id="wsStatus">WebSocket: Desconectado</span>
                <span class="status info" id="apiStatus">REST API: Verificando...</span>
            </div>
        </header>

        <div class="test-info">
            <strong>üìã Este test verificar√°:</strong>
            <ul style="margin-left: 20px; margin-top: 10px; line-height: 1.8;">
                <li>‚úÖ Conexi√≥n del WebSocket (ws://localhost:8081/ws)</li>
                <li>‚úÖ Comunicaci√≥n WebSocket ‚Üí REST API (http://localhost:3000/api)</li>
                <li>‚úÖ Inserci√≥n de datos de prueba</li>
                <li>‚úÖ Actualizaci√≥n en tiempo real del Dashboard</li>
                <li>‚úÖ Flujo completo: Ingreso ‚Üí Salida ‚Üí Pago</li>
            </ul>
        </div>

        <div class="controls">
            <button class="btn-success" onclick="iniciarTestCompleto()">üöÄ Iniciar Test Completo</button>
            <button class="btn-primary" onclick="testConexiones()">üîå Verificar Conexiones</button>
            <button class="btn-warning" onclick="testIngresosAleatorios()">üé≤ Simular Ingresos</button>
            <button class="btn-danger" onclick="testSalidasAleatorias()">üí∞ Simular Salidas</button>
            <button class="btn-info" onclick="limpiarConsola()">üóëÔ∏è Limpiar Consola</button>
            <button class="btn-primary" onclick="window.open('dashboard.html', '_blank')">üìä Abrir Dashboard</button>
        </div>

        <div class="grid">
            <div class="panel">
                <h2>üìù Consola de Eventos</h2>
                <div class="console" id="console"></div>
            </div>

            <div class="panel">
                <h2>üìä Estad√≠sticas en Vivo</h2>
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="value" id="statEspacios">-</div>
                        <div class="label">Disponibles</div>
                    </div>
                    <div class="stat-box">
                        <div class="value" id="statOcupados">-</div>
                        <div class="label">Ocupados</div>
                    </div>
                    <div class="stat-box">
                        <div class="value" id="statTotal">-</div>
                        <div class="label">Total</div>
                    </div>
                    <div class="stat-box">
                        <div class="value" id="statDineroHoy">$0</div>
                        <div class="label">Hoy</div>
                    </div>
                    <div class="stat-box">
                        <div class="value" id="statDineroMes">$0</div>
                        <div class="label">Este Mes</div>
                    </div>
                    <div class="stat-box">
                        <div class="value" id="statVehiculos">-</div>
                        <div class="label">Activos</div>
                    </div>
                </div>

                <h2 style="margin-top: 30px;">üì° √öltimos Mensajes WebSocket</h2>
                <div id="wsMessages" style="max-height: 300px; overflow-y: auto;">
                    <p style="text-align: center; color: #858585; padding: 20px;">
                        Esperando mensajes...
                    </p>
                </div>
            </div>
        </div>

        <div class="panel">
            <h2>üéØ Progreso del Test</h2>
            <div id="testProgress">
                <p style="color: #858585;">Presiona "Iniciar Test Completo" para comenzar</p>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressBar" style="width: 0%"></div>
            </div>
        </div>
    </div>

    <script>
        // Configuraci√≥n
        const API_BASE = 'http://localhost:3000/api';
        const WS_URL = 'ws://localhost:8081/ws';

        let ws = null;
        let testRunning = false;
        let vehiculosCreados = [];
        let ticketsCreados = [];

        // Conectar WebSocket
        function conectarWebSocket() {
            return new Promise((resolve, reject) => {
                log('Conectando al WebSocket...', 'info');
                
                ws = new WebSocket(WS_URL);

                ws.onopen = () => {
                    log('‚úÖ WebSocket conectado exitosamente', 'success');
                    document.getElementById('wsStatus').textContent = 'WebSocket: Conectado';
                    document.getElementById('wsStatus').className = 'status success';
                    resolve();
                };

                ws.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        log('üì® Mensaje recibido del WebSocket', 'ws');
                        
                        // Mostrar mensaje
                        const wsMessages = document.getElementById('wsMessages');
                        const messageDiv = document.createElement('div');
                        messageDiv.className = 'ws-message';
                        messageDiv.innerHTML = `
                            <strong>Tipo: ${data.type || 'dashboard_data'}</strong>
                            <pre>${JSON.stringify(data.data || data, null, 2)}</pre>
                        `;
                        wsMessages.insertBefore(messageDiv, wsMessages.firstChild);
                        
                        // Mantener solo √∫ltimos 3 mensajes
                        while (wsMessages.children.length > 3) {
                            wsMessages.removeChild(wsMessages.lastChild);
                        }
                        
                        // Actualizar estad√≠sticas
                        if (data.data || data.espacios_disponibles !== undefined) {
                            actualizarEstadisticas(data.data || data);
                        }
                    } catch (error) {
                        log(`‚ö†Ô∏è Error procesando mensaje: ${error.message}`, 'warning');
                    }
                };

                ws.onerror = (error) => {
                    log('‚ùå Error en WebSocket', 'error');
                    document.getElementById('wsStatus').textContent = 'WebSocket: Error';
                    document.getElementById('wsStatus').className = 'status error';
                    reject(error);
                };

                ws.onclose = () => {
                    log('WebSocket desconectado', 'warning');
                    document.getElementById('wsStatus').textContent = 'WebSocket: Desconectado';
                    document.getElementById('wsStatus').className = 'status warning';
                };

                // Timeout de 5 segundos
                setTimeout(() => {
                    if (ws.readyState !== WebSocket.OPEN) {
                        reject(new Error('Timeout conectando al WebSocket'));
                    }
                }, 5000);
            });
        }

        // Actualizar estad√≠sticas
        function actualizarEstadisticas(data) {
            document.getElementById('statEspacios').textContent = data.espacios_disponibles ?? '-';
            document.getElementById('statOcupados').textContent = data.espacios_ocupados ?? '-';
            document.getElementById('statTotal').textContent = data.total_espacios ?? '-';
            document.getElementById('statDineroHoy').textContent = formatMoney(data.dinero_recaudado_hoy ?? 0);
            document.getElementById('statDineroMes').textContent = formatMoney(data.dinero_recaudado_mes ?? 0);
            document.getElementById('statVehiculos').textContent = data.vehiculos_activos ?? '-';
        }

        // Formatear dinero
        function formatMoney(amount) {
            return new Intl.NumberFormat('es-MX', {
                style: 'currency',
                currency: 'MXN'
            }).format(amount);
        }

        // Logger
        function log(message, type = 'info') {
            const console = document.getElementById('console');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            
            const timestamp = new Date().toLocaleTimeString('es-MX');
            entry.innerHTML = `<span class="timestamp">[${timestamp}]</span>${message}`;
            
            console.insertBefore(entry, console.firstChild);
            
            // Mantener solo √∫ltimos 100 logs
            while (console.children.length > 100) {
                console.removeChild(console.lastChild);
            }
        }

        // Limpiar consola
        function limpiarConsola() {
            document.getElementById('console').innerHTML = '';
            log('Consola limpiada', 'info');
        }

        // Verificar API
        async function verificarAPI() {
            try {
                log('Verificando conexi√≥n con REST API...', 'info');
                const response = await fetch(`${API_BASE}/dashboard/health`);
                
                if (response.ok) {
                    log('‚úÖ REST API respondiendo correctamente', 'success');
                    document.getElementById('apiStatus').textContent = 'REST API: Conectado';
                    document.getElementById('apiStatus').className = 'status success';
                    return true;
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                log(`‚ùå Error conectando con REST API: ${error.message}`, 'error');
                document.getElementById('apiStatus').textContent = 'REST API: Error';
                document.getElementById('apiStatus').className = 'status error';
                return false;
            }
        }

        // Test de conexiones
        async function testConexiones() {
            log('üîç Iniciando verificaci√≥n de conexiones...', 'info');
            
            const apiOk = await verificarAPI();
            
            if (!apiOk) {
                log('‚ö†Ô∏è No se puede continuar sin REST API', 'warning');
                return false;
            }
            
            try {
                await conectarWebSocket();
                log('‚úÖ Todas las conexiones establecidas correctamente', 'success');
                return true;
            } catch (error) {
                log(`‚ùå Error en conexiones: ${error.message}`, 'error');
                return false;
            }
        }

        // Crear datos de prueba
        async function crearDatosPrueba() {
            log('üì¶ Creando datos de prueba...', 'info');
            
            try {
                // Obtener tipos de veh√≠culo y clientes
                const tiposResp = await fetch(`${API_BASE}/tipo-vehiculo`);
                const tipos = await tiposResp.json();
                
                const clientesResp = await fetch(`${API_BASE}/cliente`);
                const clientes = await clientesResp.json();
                
                if (tipos.length === 0 || clientes.length === 0) {
                    log('‚ö†Ô∏è Faltan datos b√°sicos. Ejecuta el script seed-data.sql primero', 'warning');
                    return false;
                }
                
                log(`‚úÖ Encontrados ${tipos.length} tipos de veh√≠culo y ${clientes.length} clientes`, 'success');
                
                // Crear 3 veh√≠culos de prueba
                const placas = ['TEST-001', 'TEST-002', 'TEST-003'];
                
                for (const placa of placas) {
                    const vehiculo = {
                        placa: placa,
                        marca: 'Toyota',
                        modelo: 'Corolla',
                        clienteId: clientes[0].id,
                        tipoVehiculoId: tipos[0].id
                    };
                    
                    try {
                        const resp = await fetch(`${API_BASE}/vehicle`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(vehiculo)
                        });
                        
                        if (resp.ok) {
                            const created = await resp.json();
                            vehiculosCreados.push(created);
                            log(`‚úÖ Veh√≠culo creado: ${placa}`, 'success');
                        }
                    } catch (e) {
                        log(`‚ÑπÔ∏è Veh√≠culo ${placa} ya existe`, 'info');
                    }
                }
                
                return true;
            } catch (error) {
                log(`‚ùå Error creando datos: ${error.message}`, 'error');
                return false;
            }
        }

        // Test de ingresos aleatorios
        async function testIngresosAleatorios() {
            log('üöó Iniciando test de ingresos...', 'info');
            
            try {
                // Obtener espacios disponibles
                const espaciosResp = await fetch(`${API_BASE}/dashboard/espacios/disponibles`);
                const espacios = await espaciosResp.json();
                
                if (espacios.length === 0) {
                    log('‚ö†Ô∏è No hay espacios disponibles', 'warning');
                    return;
                }
                
                // Obtener veh√≠culos
                const vehiculosResp = await fetch(`${API_BASE}/vehicle`);
                const vehiculos = await vehiculosResp.json();
                
                if (vehiculos.length === 0) {
                    log('‚ö†Ô∏è No hay veh√≠culos. Creando datos de prueba...', 'warning');
                    await crearDatosPrueba();
                    return testIngresosAleatorios();
                }
                
                // Crear ingreso
                const vehiculo = vehiculos[Math.floor(Math.random() * vehiculos.length)];
                const espacio = espacios[Math.floor(Math.random() * espacios.length)];
                
                const ticket = {
                    vehiculoId: vehiculo.id,
                    espacioId: espacio.id,
                    fechaIngreso: new Date().toISOString()
                };
                
                const resp = await fetch(`${API_BASE}/tickets`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(ticket)
                });
                
                if (resp.ok) {
                    const created = await resp.json();
                    ticketsCreados.push(created);
                    log(`‚úÖ Ingreso registrado: ${vehiculo.placa} ‚Üí ${espacio.numero}`, 'success');
                    log(`‚è±Ô∏è El dashboard deber√≠a actualizarse en ~5 segundos`, 'info');
                } else {
                    const error = await resp.json();
                    log(`‚ùå Error registrando ingreso: ${error.message}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Error en test de ingresos: ${error.message}`, 'error');
            }
        }

        // Test de salidas aleatorias
        async function testSalidasAleatorias() {
            log('üí∞ Iniciando test de salidas...', 'info');
            
            try {
                // Obtener tickets activos
                const ticketsResp = await fetch(`${API_BASE}/dashboard/tickets/activos`);
                const tickets = await ticketsResp.json();
                
                if (tickets.length === 0) {
                    log('‚ö†Ô∏è No hay tickets activos para procesar', 'warning');
                    return;
                }
                
                const ticket = tickets[0];
                const monto = (Math.random() * 100 + 20).toFixed(2);
                
                // Obtener tarifa
                const tarifasResp = await fetch(`${API_BASE}/tipo-tarifa`);
                const tarifas = await tarifasResp.json();
                
                if (tarifas.length === 0) {
                    log('‚ùå No hay tarifas configuradas', 'error');
                    return;
                }
                
                // Crear pago
                const pagoResp = await fetch(`${API_BASE}/pagos`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        monto: parseFloat(monto),
                        tipoTarifaId: tarifas[0].id
                    })
                });
                
                if (!pagoResp.ok) {
                    log('‚ùå Error creando pago', 'error');
                    return;
                }
                
                const pago = await pagoResp.json();
                
                // Crear detalle de pago
                const detalleResp = await fetch(`${API_BASE}/detalle-pago`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        metodo: 'Efectivo',
                        fechaPago: new Date().toISOString(),
                        pagoTotal: parseFloat(monto),
                        ticketId: ticket.id,
                        pagoId: pago.id
                    })
                });
                
                if (!detalleResp.ok) {
                    log('‚ùå Error creando detalle de pago', 'error');
                    return;
                }
                
                const detalle = await detalleResp.json();
                
                // Actualizar ticket
                const updateResp = await fetch(`${API_BASE}/tickets/${ticket.id}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        fechaSalida: new Date().toISOString(),
                        detallePagoId: detalle.id
                    })
                });
                
                if (updateResp.ok) {
                    log(`‚úÖ Salida registrada: ${ticket.vehiculo_placa} - $${monto}`, 'success');
                    log(`‚è±Ô∏è El dashboard deber√≠a actualizarse en ~5 segundos`, 'info');
                } else {
                    log('‚ùå Error actualizando ticket', 'error');
                }
            } catch (error) {
                log(`‚ùå Error en test de salidas: ${error.message}`, 'error');
            }
        }

        // Test completo
        async function iniciarTestCompleto() {
            if (testRunning) {
                log('‚ö†Ô∏è Ya hay un test en ejecuci√≥n', 'warning');
                return;
            }
            
            testRunning = true;
            limpiarConsola();
            
            log('üöÄ Iniciando test completo del sistema...', 'success');
            document.getElementById('testProgress').innerHTML = '<p>Ejecutando test...</p>';
            
            let progress = 0;
            const updateProgress = (value) => {
                progress = value;
                document.getElementById('progressBar').style.width = `${value}%`;
            };
            
            try {
                // Paso 1: Verificar conexiones (20%)
                updateProgress(10);
                log('üìç Paso 1/5: Verificando conexiones...', 'info');
                const conexionesOk = await testConexiones();
                if (!conexionesOk) {
                    log('‚ùå Test cancelado: Problemas de conexi√≥n', 'error');
                    testRunning = false;
                    return;
                }
                updateProgress(20);
                await esperar(2000);
                
                // Paso 2: Crear datos (40%)
                updateProgress(30);
                log('üìç Paso 2/5: Creando datos de prueba...', 'info');
                await crearDatosPrueba();
                updateProgress(40);
                await esperar(2000);
                
                // Paso 3: Test ingresos (60%)
                updateProgress(50);
                log('üìç Paso 3/5: Probando registro de ingresos...', 'info');
                await testIngresosAleatorios();
                updateProgress(60);
                log('‚è±Ô∏è Esperando actualizaci√≥n del WebSocket...', 'info');
                await esperar(6000); // Esperar 6 segundos para ver la actualizaci√≥n
                
                // Paso 4: Test salidas (80%)
                updateProgress(70);
                log('üìç Paso 4/5: Probando registro de salidas...', 'info');
                await testSalidasAleatorias();
                updateProgress(80);
                log('‚è±Ô∏è Esperando actualizaci√≥n del WebSocket...', 'info');
                await esperar(6000);
                
                // Paso 5: Finalizar (100%)
                updateProgress(90);
                log('üìç Paso 5/5: Verificando estado final...', 'info');
                await esperar(2000);
                updateProgress(100);
                
                log('‚úÖ Test completo finalizado exitosamente!', 'success');
                log('üìä Revisa el dashboard para ver los cambios en tiempo real', 'info');
                
                document.getElementById('testProgress').innerHTML = `
                    <p style="color: #4caf50;">‚úÖ Test completado exitosamente!</p>
                    <p style="color: #858585; margin-top: 10px;">
                        El WebSocket est√° recibiendo actualizaciones cada 5 segundos.<br>
                        Los datos se est√°n sincronizando correctamente entre REST API y WebSocket.
                    </p>
                `;
                
            } catch (error) {
                log(`‚ùå Error en test completo: ${error.message}`, 'error');
                document.getElementById('testProgress').innerHTML = `
                    <p style="color: #f44336;">‚ùå Error en el test: ${error.message}</p>
                `;
            } finally {
                testRunning = false;
            }
        }

        // Utilidades
        function esperar(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // Inicializar al cargar
        window.addEventListener('load', async () => {
            log('üîß Aplicaci√≥n de test iniciada', 'info');
            log('üì° Esperando comandos...', 'info');
            
            // Auto-verificar conexiones
            setTimeout(() => {
                testConexiones();
            }, 1000);
        });

        // Limpiar al cerrar
        window.addEventListener('beforeunload', () => {
            if (ws) ws.close();
        });
    </script>
</body>
</html>
